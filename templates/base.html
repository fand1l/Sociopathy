{% load static %}

<!DOCTYPE html>
<html lang="uk"
    {% if user.is_authenticated and user.profile.theme_preference == "light" %}data-theme="light"{% endif %}
    {% if user.is_authenticated and user.profile.accent_preference != "default" %}data-accent="{{ user.profile.accent_preference }}"{% endif %}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link href="https://cdn.boxicons.com/3.0.8/fonts/basic/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.boxicons.com/3.0.8/fonts/filled/boxicons-filled.min.css" rel="stylesheet">
    {% block extra_head %}{% endblock %}
    <title>{% block title %}Sociopathy{% endblock %}</title>
</head>
<body class="site" data-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}">
    <aside class="site__sidebar">
        <div class="sidebar__inner">
            <div class="sidebar__logo">
                <a href="{% url 'posts:home' %}">
                    <img src="{% static 'assets/logo.svg' %}" alt="Sociopathy Logo" class="logo-img">
                </a>
            </div>

            <nav class="sidebar__menu menu">
                <ul class="menu__list">
                    <li class="menu__item">
                        <a href="{% url 'posts:home' %}" class="menu__link {% if request.resolver_match.view_name == 'posts:home' %}menu__link--active{% endif %}">
                            <i class="bx bx-home-alt-2"></i>
                        </a>
                    </li>
                    <li class="menu__item">
                        <a href="#" class="menu__link">
                            <i class="bx bx-compass"></i>
                        </a>
                    </li>
                    <li class="menu__item new_post">
                        {% if user.is_authenticated %}
                            <a href="#" class="menu__link">
                                <i class="bx bx-plus rotating"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'accounts:register' %}" class="menu__link">
                                <i class="bx bx-plus"></i>
                            </a>
                        {% endif %}
                    </li>
                    <li class="menu__item">
                        <a href="{% url 'bookmarks:list' %}" class="menu__link {% if request.resolver_match.view_name == 'bookmarks:list' %}menu__link--active{% endif %}">
                            <i class="bx bx-bookmark"></i>
                        </a>
                    </li>
                    <li class="menu__item menu__item--dropdown">
                        {% if user.is_authenticated %}
                            <a href="{% url 'accounts:profile' %}" class="menu__link {% if request.resolver_match.view_name == 'accounts:profile' %}menu__link--active{% endif %}">
                                <i class="bx bx-user"></i>
                            </a>
                            <div class="sidebar-dropdown" aria-label="Профіль">
                                <a href="{% url 'accounts:profile' %}" class="sidebar-dropdown__item">
                                    <i class="bx bx-user"></i>
                                    <span>Профіль</span>
                                </a>
                                <a href="{% url 'chat:thread_list' %}" class="sidebar-dropdown__item">
                                    <i class="bx bx-message-circle"></i>
                                    <span>Повідомлення</span>
                                </a>
                            </div>
                        {% else %}
                            <a href="{% url 'accounts:login' %}" class="menu__link">
                                <i class="bx bx-user"></i>
                            </a>
                            <div class="sidebar-dropdown" aria-label="Профіль">
                                <a href="{% url 'accounts:login' %}" class="sidebar-dropdown__item">
                                    <i class="bx bx-user"></i>
                                    <span>Профіль</span>
                                </a>
                                <a href="{% url 'accounts:login' %}" class="sidebar-dropdown__item">
                                    <i class="bx bx-message-circle"></i>
                                    <span>Повідомлення</span>
                                </a>
                            </div>
                        {% endif %}
                    </li>
                </ul>
            </nav>

            <div class="sidebar__settings menu__item--dropdown">
                {% if user.is_authenticated %}
                    <button type="button" class="menu__link" title="Налаштування" aria-label="Налаштування">
                        <i class="bx bx-cog rotating"></i>
                    </button>
                    <div class="sidebar-dropdown" aria-label="Налаштування">
                        <div class="theme-switcher">
                            <button type="button" class="sidebar-dropdown__item theme-switcher__button" data-theme-value="dark">
                                <i class="bx bx-moon"></i>
                                <span>Темна</span>
                            </button>
                            <button type="button" class="sidebar-dropdown__item theme-switcher__button" data-theme-value="light">
                                <i class="bx bx-sun"></i>
                                <span>Світла</span>
                            </button>
                        </div>

                        <div class="sidebar-dropdown__divider"></div>

                        <div class="accent-picker">
                            <span class="accent-picker__title">Колір акценту:</span>
                            <div class="accent-picker__grid">
                                <button class="accent-dot accent-dot--white" data-color="default" title="Default"></button>
                                <button class="accent-dot accent-dot--blue" data-color="blue" title="Blue"></button>
                                <button class="accent-dot accent-dot--purple" data-color="purple" title="Purple"></button>
                                <button class="accent-dot accent-dot--pink" data-color="pink" title="Pink"></button>
                                <button class="accent-dot accent-dot--orange" data-color="orange" title="Orange"></button>
                            </div>
                        </div>

                        <div class="sidebar-dropdown__divider"></div>

                        <a href="{% url 'accounts:logout' %}?next={% url 'accounts:login' %}" class="sidebar-dropdown__item">
                            <i class="bx bx-refresh-cw"></i>
                            <span>Змінити обліковий запис</span>
                        </a>
                        <button type="button" class="sidebar-dropdown__item sidebar-dropdown__item--danger logout-trigger">
                            <i class="bx bx-arrow-out-right-square-half"></i>
                            <span>Вийти</span>
                        </button>
                    </div>
                {% else %}
                    <a href="{% url 'accounts:login' %}" class="menu__link" title="Увійти">
                        <i class="bx bx-cog"></i>
                    </a>
                    <div class="sidebar-dropdown" aria-label="Налаштування">
                        <div class="theme-switcher">
                            <button type="button" class="sidebar-dropdown__item theme-switcher__button" data-theme-value="dark">
                                <i class="bx bx-moon"></i>
                                <span>Темна</span>
                            </button>
                            <button type="button" class="sidebar-dropdown__item theme-switcher__button" data-theme-value="light">
                                <i class="bx bx-sun"></i>
                                <span>Світла</span>
                            </button>
                        </div>

                        <div class="sidebar-dropdown__divider"></div>

                        <div class="accent-picker">
                            <span class="accent-picker__title">Колір акценту:</span>
                            <div class="accent-picker__grid">
                                <button class="accent-dot accent-dot--white" data-color="default" title="Default"></button>
                                <button class="accent-dot accent-dot--blue" data-color="blue" title="Blue"></button>
                                <button class="accent-dot accent-dot--purple" data-color="purple" title="Purple"></button>
                                <button class="accent-dot accent-dot--pink" data-color="pink" title="Pink"></button>
                                <button class="accent-dot accent-dot--orange" data-color="orange" title="Orange"></button>
                            </div>
                        </div>

                        <div class="sidebar-dropdown__divider"></div>

                        <a href="{% url 'accounts:login' %}" class="sidebar-dropdown__item">
                            <i class="bx bx-arrow-in-right-square-half"></i>
                            <span>Логін</span>
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </aside>

    <main class="site__main"> <header class="site__header">
            <h1 class="header__title">{% block header_title %}Головна{% endblock %}</h1>
        </header>

        <section class="site__content {% block content_class %}{% endblock %}">
            {% block content %}{% endblock %}
        </section>
    </main>

    {% if user.is_authenticated %}
    <div class="confirm-modal" id="logoutModal" aria-hidden="true">
        <div class="confirm-modal__content" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
            <div class="confirm-modal__header">
                <h3 id="logoutTitle">Підтвердити вихід</h3>
                <button type="button" class="confirm-modal__close" aria-label="Закрити">
                    <i class="bx bx-x"></i>
                </button>
            </div>
            <p class="confirm-modal__text">Ви точно хочете вийти з акаунта?</p>
            <form method="POST" action="{% url 'accounts:logout' %}">
                {% csrf_token %}
                <div class="confirm-modal__actions">
                    <button type="button" class="confirm-modal__cancel">Скасувати</button>
                    <button type="submit" class="confirm-modal__confirm logout-confirm">Вийти</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('logoutModal');
            const triggers = document.querySelectorAll('.logout-trigger');
            if (!modal || !triggers.length) return;

            const closeButtons = modal.querySelectorAll('.confirm-modal__close, .confirm-modal__cancel');

            const openModal = () => {
                modal.classList.add('confirm-modal--open');
                modal.setAttribute('aria-hidden', 'false');
            };

            const closeModal = () => {
                modal.classList.remove('confirm-modal--open');
                modal.setAttribute('aria-hidden', 'true');
            };

            triggers.forEach((trigger) => trigger.addEventListener('click', openModal));
            closeButtons.forEach((btn) => btn.addEventListener('click', closeModal));
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });
        });

        const html = document.documentElement;
        const isAuthenticated = document.body.dataset.auth === '1';
        const preferencesUrl = '{% url "accounts:theme_preferences" %}';

        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return '';
        };

        const persistPreferences = (payload) => {
            if (!isAuthenticated) {
                if (payload.theme) localStorage.setItem('site-theme', payload.theme);
                if (payload.accent) localStorage.setItem('site-accent', payload.accent);
                return;
            }

            fetch(preferencesUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(payload),
            }).catch(() => {});
        };

        const syncThemeButtons = (theme) => {
            document.querySelectorAll('.theme-switcher__button').forEach((btn) => {
                btn.classList.toggle('is-active', btn.dataset.themeValue === theme);
            });
        };

        const syncAccentDots = (accent) => {
            document.querySelectorAll('.accent-dot').forEach((dot) => {
                dot.classList.toggle('is-active', dot.dataset.color === accent);
            });
        };

        const updateTheme = (theme, persist = true) => {
            if (theme === 'light') html.setAttribute('data-theme', 'light');
            else html.removeAttribute('data-theme');
            syncThemeButtons(theme);
            if (persist) persistPreferences({ theme });
        };

        const updateAccent = (color, persist = true) => {
            if (color === 'default') html.removeAttribute('data-accent');
            else html.setAttribute('data-accent', color);
            syncAccentDots(color);
            if (persist) persistPreferences({ accent: color });
        };

        document.querySelectorAll('.theme-switcher__button').forEach((btn) => {
            btn.addEventListener('click', () => updateTheme(btn.dataset.themeValue));
        });

        document.querySelectorAll('.accent-dot').forEach((dot) => {
            dot.addEventListener('click', () => updateAccent(dot.getAttribute('data-color')));
        });

        if (!isAuthenticated) {
            const savedTheme = localStorage.getItem('site-theme');
            const savedAccent = localStorage.getItem('site-accent');

            if (savedTheme) updateTheme(savedTheme, false);
            if (savedAccent) updateAccent(savedAccent, false);
        } else {
            const currentTheme = html.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
            const currentAccent = html.getAttribute('data-accent') || 'default';
            syncThemeButtons(currentTheme);
            syncAccentDots(currentAccent);
        }
    </script>
</body>
</html>