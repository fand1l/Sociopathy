{% extends 'base.html' %}
{% load static %}

{% block title %}Чат{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content_class %}site__content--chat{% endblock %}

{% block header_title %}Чат{% endblock %}

{% block content %}
<div class="chat-layout{% if not thread %} chat-layout--list{% endif %}">
    <aside class="chat-threads{% if not thread %} chat-threads--center{% endif %}">
        <div class="chat-panel__header">
            <h2>Діалоги</h2>
            <p>Оберіть користувача, щоб почати спілкування.</p>
        </div>
        <div class="chat-thread-list">
            {% for item in thread_items %}
                <a class="chat-thread {% if thread and item.thread.id == thread.id %}chat-thread--active{% endif %}" href="{% url 'chat:chat_thread_detail' item.thread.id %}">
                    <div class="chat-thread__avatar" data-user-id="{{ item.other.id }}" data-is-friend="{{ item.is_friend|yesno:'true,false' }}">
                        <img src="{{ item.other.profile.avatar_url }}" alt="{{ item.other.username }}" />
                        {% if item.is_friend %}
                            <span class="chat-status-indicator{% if item.is_online %} chat-status-indicator--online{% endif %}" aria-label="Онлайн"></span>
                        {% endif %}
                    </div>
                    <div class="chat-thread__body">
                        <div class="chat-thread__name">{{ item.other.username }}</div>
                        <div class="chat-thread__meta">Останнє оновлення: {{ item.thread.updated_at|date:"d.m.Y H:i" }}</div>
                    </div>
                </a>
            {% empty %}
                <div class="chat-empty">Немає доступних діалогів.</div>
            {% endfor %}
        </div>
    </aside>

    {% if thread %}
    <section class="chat-panel" data-other-user-id="{{ other_user.id }}" data-is-friend="{{ is_friend|yesno:'true,false' }}">
        <div class="chat-panel__header">
            <div class="chat-panel__title">
                <div class="chat-panel__avatar" data-user-id="{{ other_user.id }}" data-is-friend="{{ is_friend|yesno:'true,false' }}">
                    <img src="{{ other_user.profile.avatar_url }}" alt="{{ other_user.username }}" />
                    {% if is_friend %}
                        <span class="chat-status-indicator{% if is_online %} chat-status-indicator--online{% endif %}" aria-label="Онлайн"></span>
                    {% endif %}
                </div>
                <div>
                    <h2>{{ other_user.username }}</h2>
                    <p>Спілкування в реальному часі</p>
                </div>
            </div>
            <div id="chatTyping" class="chat-typing" aria-live="polite">Користувач друкує...</div>
        </div>

        <ul id="chatMessages" class="chat-messages" aria-live="polite" data-current-user-id="{{ request.user.id }}">
            {% for message in chat_messages %}
                <li class="chat-message {% if message.sender_id == request.user.id %}chat-message--own{% endif %}" data-message-id="{{ message.id }}" data-sender-id="{{ message.sender_id }}">
                    <div class="chat-message__meta">
                        <span>{{ message.sender.username }}</span>
                        <time datetime="{{ message.created_at|date:"c" }}">{{ message.created_at|date:"H:i" }}</time>
                        {% if message.sender_id == request.user.id %}
                            <span class="chat-message__status">{% if message.read_at %}Прочитано{% endif %}</span>
                        {% endif %}
                    </div>
                    <div class="chat-message__bubble">
                        {% if message.text %}
                            <p class="chat-message__text">{{ message.text }}</p>
                        {% endif %}
                        {% if message.image %}
                            <a class="chat-message__image-link" href="{{ message.image.url }}" target="_blank" rel="noopener" aria-label="Відкрити зображення">
                                <img class="chat-message__image" src="{{ message.image.url }}" alt="Зображення" loading="lazy" />
                            </a>
                        {% endif %}
                        {% if message.file %}
                            <a class="chat-message__file" href="{{ message.file.url }}" target="_blank" rel="noopener" aria-label="Відкрити файл">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm6 1.5V9h4.5L13 4.5z" />
                                </svg>
                            </a>
                        {% endif %}
                    </div>
                </li>
            {% empty %}
                <li class="chat-empty">Немає повідомлень. Напишіть першим!</li>
            {% endfor %}
        </ul>

        <form id="chatForm" class="chat-form" autocomplete="off" method="post" enctype="multipart/form-data" action="{% url 'chat:chat_thread_send' thread.id %}">
            {% csrf_token %}
            <input type="text" id="chatInput" name="text" placeholder="Напишіть повідомлення...">
            <label class="chat-form__file" for="chatImage" aria-label="Додати фото" title="Додати фото">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 5h4l1.5-2h5L16 5h4a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2zm8 3.5A4.5 4.5 0 1 0 16.5 13 4.5 4.5 0 0 0 12 8.5z" />
                </svg>
                <input type="file" id="chatImage" name="image" accept="image/*">
            </label>
            <label class="chat-form__file" for="chatFile" aria-label="Додати файл" title="Додати файл">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M16.5 6.5 9 14a3 3 0 0 0 4.2 4.2l6.3-6.3a4.5 4.5 0 0 0-6.4-6.4L6.5 12.1" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
                </svg>
                <input type="file" id="chatFile" name="file">
            </label>
            <button type="submit">Надіслати</button>
        </form>
        <div id="chatAttachmentPreview" class="chat-attachments-preview" aria-live="polite"></div>
    </section>
    {% endif %}
</div>

{% if thread %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const messagesEl = document.getElementById('chatMessages');
        const formEl = document.getElementById('chatForm');
        const inputEl = document.getElementById('chatInput');
        const typingEl = document.getElementById('chatTyping');
        const imageInput = document.getElementById('chatImage');
        const fileInput = document.getElementById('chatFile');
        const previewEl = document.getElementById('chatAttachmentPreview');
        const panelEl = document.querySelector('.chat-panel');
        if (!messagesEl || !formEl || !inputEl || !panelEl) return;

        const threadId = "{{ thread.id }}";
        const currentUserId = Number(messagesEl.dataset.currentUserId);
        const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${scheme}://${window.location.host}/ws/chat/${threadId}/`);

        const findStatusIndicators = (userId) =>
            document.querySelectorAll(`.chat-thread__avatar[data-user-id="${userId}"], .chat-panel__avatar[data-user-id="${userId}"]`);

        const updateOnlineIndicator = (userId, isOnline) => {
            findStatusIndicators(userId).forEach((el) => {
                if (el.dataset.isFriend !== 'true') return;
                const indicator = el.querySelector('.chat-status-indicator');
                if (!indicator) return;
                indicator.classList.toggle('chat-status-indicator--online', isOnline);
            });
        };

        const scrollToBottom = () => {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        };

        const buildBubble = (payload) => {
            const bubble = document.createElement('div');
            bubble.className = 'chat-message__bubble';

            if (payload.message) {
                const textEl = document.createElement('p');
                textEl.className = 'chat-message__text';
                textEl.textContent = payload.message;
                bubble.appendChild(textEl);
            }

            if (payload.image_url) {
                const link = document.createElement('a');
                link.className = 'chat-message__image-link';
                link.href = payload.image_url;
                link.target = '_blank';
                link.rel = 'noopener';

                const image = document.createElement('img');
                image.className = 'chat-message__image';
                image.src = payload.image_url;
                image.alt = 'Зображення';
                image.loading = 'lazy';
                link.appendChild(image);
                bubble.appendChild(link);
            }

            if (payload.file_url) {
                const fileLink = document.createElement('a');
                fileLink.className = 'chat-message__file';
                fileLink.href = payload.file_url;
                fileLink.target = '_blank';
                fileLink.rel = 'noopener';
                fileLink.setAttribute('aria-label', payload.file_name || 'Файл');
                fileLink.innerHTML = `
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm6 1.5V9h4.5L13 4.5z" />
                    </svg>
                `;
                bubble.appendChild(fileLink);
            }

            return bubble;
        };

        const appendMessage = (payload) => {
            const item = document.createElement('li');
            item.className = 'chat-message';
            item.dataset.messageId = payload.message_id;
            item.dataset.senderId = payload.sender_id;
            if (payload.sender_id === currentUserId) {
                item.classList.add('chat-message--own');
            }
            item.innerHTML = `
                <div class="chat-message__meta">
                    <span>${payload.username}</span>
                    <time>${new Date(payload.created_at || Date.now()).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })}</time>
                    ${payload.sender_id === currentUserId ? '<span class="chat-message__status"></span>' : ''}
                </div>
            `;
            item.appendChild(buildBubble(payload));
            messagesEl.appendChild(item);
            scrollToBottom();
            maybeSendReadReceipt();
        };

        const canMarkRead = () => !document.hidden && document.hasFocus();

        const maybeSendReadReceipt = () => {
            if (!canMarkRead()) return;
            const lastMessage = Array.from(messagesEl.querySelectorAll('.chat-message'))
                .filter((item) => Number(item.dataset.senderId) !== currentUserId)
                .pop();
            if (!lastMessage) return;
            const nearBottom = messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 20;
            if (!nearBottom) return;
            socket.send(JSON.stringify({ type: 'read', message_id: Number(lastMessage.dataset.messageId) }));
        };

        let typingTimeout = null;
        const sendTyping = (isTyping) => {
            socket.send(JSON.stringify({ type: 'typing', is_typing: isTyping }));
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'message') {
                appendMessage(data);
                return;
            }
            if (data.type === 'typing') {
                if (!typingEl || data.user_id === currentUserId) return;
                typingEl.classList.toggle('chat-typing--active', data.is_typing);
                return;
            }
            if (data.type === 'presence') {
                updateOnlineIndicator(data.user_id, data.is_online);
                return;
            }
            if (data.type === 'read_receipt') {
                if (data.reader_id === currentUserId) return;
                (data.message_ids || []).forEach((messageId) => {
                    const messageEl = messagesEl.querySelector(`[data-message-id="${messageId}"]`);
                    if (!messageEl || !messageEl.classList.contains('chat-message--own')) return;
                    const statusEl = messageEl.querySelector('.chat-message__status');
                    if (statusEl) statusEl.textContent = 'Прочитано';
                });
            }
        };

        formEl.addEventListener('submit', async (event) => {
            event.preventDefault();
            const hasText = inputEl.value.trim();
            const hasImage = imageInput && imageInput.files && imageInput.files.length > 0;
            const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
            if (!hasText && !hasImage && !hasFile) return;

            const formData = new FormData(formEl);
            const response = await fetch(formEl.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin',
            });

            if (!response.ok) {
                const errorPayload = await response.json().catch(() => null);
                console.error('Chat upload failed', errorPayload);
                return;
            }

            inputEl.value = '';
            if (imageInput) imageInput.value = '';
            if (fileInput) fileInput.value = '';
            if (previewEl) previewEl.innerHTML = '';
        });

        const renderAttachmentPreview = () => {
            if (!previewEl) return;
            previewEl.innerHTML = '';

            if (imageInput && imageInput.files && imageInput.files[0]) {
                const imageFile = imageInput.files[0];
                const imageUrl = URL.createObjectURL(imageFile);
                const imageWrap = document.createElement('div');
                imageWrap.className = 'chat-attachments-preview__item';
                imageWrap.dataset.type = 'image';

                const image = document.createElement('img');
                image.className = 'chat-attachments-preview__image';
                image.src = imageUrl;
                image.alt = 'Превью фото';
                image.onload = () => URL.revokeObjectURL(imageUrl);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'chat-attachments-preview__remove';
                removeBtn.setAttribute('aria-label', 'Прибрати фото');
                removeBtn.innerHTML = '&times;';

                imageWrap.appendChild(image);
                imageWrap.appendChild(removeBtn);
                previewEl.appendChild(imageWrap);
            }

            if (fileInput && fileInput.files && fileInput.files[0]) {
                const fileWrap = document.createElement('div');
                fileWrap.className = 'chat-attachments-preview__item';
                fileWrap.dataset.type = 'file';

                const fileCard = document.createElement('div');
                fileCard.className = 'chat-attachments-preview__file';
                fileCard.innerHTML = `
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M7 3h7l5 5v11a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm6 1.5V9h4.5L13 4.5z" />
                    </svg>
                `;

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'chat-attachments-preview__remove';
                removeBtn.setAttribute('aria-label', 'Прибрати файл');
                removeBtn.innerHTML = '&times;';

                fileWrap.appendChild(fileCard);
                fileWrap.appendChild(removeBtn);
                previewEl.appendChild(fileWrap);
            }
        };

        const clearAttachment = (type) => {
            if (type === 'image' && imageInput) {
                imageInput.value = '';
            }
            if (type === 'file' && fileInput) {
                fileInput.value = '';
            }
            renderAttachmentPreview();
        };

        inputEl.addEventListener('input', () => {
            if (typingTimeout) clearTimeout(typingTimeout);
            sendTyping(true);
            typingTimeout = setTimeout(() => sendTyping(false), 1200);
        });

        if (imageInput) imageInput.addEventListener('change', renderAttachmentPreview);
        if (fileInput) fileInput.addEventListener('change', renderAttachmentPreview);
        if (previewEl) {
            previewEl.addEventListener('click', (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                if (!target.classList.contains('chat-attachments-preview__remove')) return;
                const wrap = target.closest('.chat-attachments-preview__item');
                if (!wrap) return;
                clearAttachment(wrap.dataset.type);
            });
        }

        inputEl.addEventListener('blur', () => sendTyping(false));
        messagesEl.addEventListener('scroll', maybeSendReadReceipt);
        window.addEventListener('focus', maybeSendReadReceipt);
        document.addEventListener('visibilitychange', maybeSendReadReceipt);
        scrollToBottom();
        requestAnimationFrame(scrollToBottom);
        maybeSendReadReceipt();
    });
</script>
{% endif %}
{% endblock %}
